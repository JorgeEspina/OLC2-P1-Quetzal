<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <!--<link rel="icon" href="%PUBLIC_URL%/favicon.ico" />-->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <!-- CSS only -->
    <link rel="stylesheet" href="https://bootswatch.com/4/darkly/bootstrap.min.css">
    <script src="css/lib/codemirror.js"></script>
    <script src="css/addon/edit/closetag.js"></script>
    <script src="css/javascript/javascript.js"></script>
    
    <!-- CSS only -->
    <link href="css/lib/codemirror.css" rel="stylesheet"/>
    <link href="css/theme/erlang-dark.css" rel="stylesheet"/>
    <link href="css/theme/isotope.css" rel="stylesheet"/>
    <link href="css/theme/darcula.css" rel="stylesheet"/>
    <link href="css/theme/dracula.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="stylesheet" href="./AST/chart/chart.css">
    <script src="./jsPDF/libs/jspdf.umd.js"></script>
    <script src="./jsPDF/jspdf.plugin.autotable.js"></script>
    <title>Quetzal Grupo #40</title>
  </head>
  <body>
    <div><p></p></div>
    <div class="container-fluid">

        <nav class="navbar navbar-expand-sm bg-secondary navbar-light bg-light">
            <!-- Image and text -->
            <nav class="navbar navbar-light bg-light">
                <a class="navbar-brand" href="#">
                <img src="Quetzal.jpg" width="30" height="30" class="d-inline-block align-top" alt="">
                Quetzal-OLC2-P1-G40
                </a>
            </nav>
            <ul class="navbar-nav">
                <li class="nav-item" href="AST.html">
                    <input type="file" name="" class="btn btn-block btn-md btn-warning" id="open-file" >
                </li>
                <!--<li class="nav-item">
                    <input type="button" value="Guardar Archivo" class="btn btn-block btn-md btn-outline-light" id="BtnGuardarArchivo">
                </li>-->

                <li class="nav-item">
                    <a class="btn btn-lg btn-outline-success" id="BtnCompilar">
                        <i class="fas fa-cogs"></i> Compilar<br></a>
                    <!--<span class="input-group-text" id="inputGroupPrepend"><i class="ti-search"></i> </span>
                    <input type="button" value="Compilar" class="btn btn-block btn-md btn-success" id="BtnCompilar">-->
                    <br>
                </li>
                <li class="nav-item">
                    <a class="btn btn-lg btn-outline-info" id="BtnLimpiar">
                        <i class="fas fa-broom"></i> Limpiar<br></a>
                    <!--<span class="input" id="BtnLimpiar"><i class="fas fa-broom"></i> </span>-->
                </li>
                <!--
                <li class="nav-item">
                    <a href="TablaSimbolos.html" class="btn btn-block btn-md btn-outline-info"  id="BtnTablaSimbolos">Tabla de Simbolos</a>  
                </li>

                <li class="nav-item">
                    <a href="Errores.html" class="btn btn-block btn-md btn-outline-danger" id="BtnReporteErrores">Reporte de Errores</a>  
                </li>-->

                <!--<li class="nav-item">
                    <a href="AST.html" class="btn btn-block btn-md btn-outline-warning">Arbol AST</a>                    
                </li>-->
                <!--<li class="nav-item">
                    <a href="#" class="btn btn-block btn-md btn-outline-primary">Reporte Gramatical</a>                    
                </li>-->
            </ul>
        </nav>
       
        <p>  </p>
        <hr>
        <div class="row justify-content-md-center">
            <div class="col-md-6 ">
                <h5 align="center">Editor</h5>
                <!--<input type="button" value="Editor" class="btn btn-block btn-md btn-primary" >-->
            </div>
            <div class="col-md-6">
                <h5 align="center">Salida</h5>
                <!--<input type="button" value="Ejecucion" class="btn btn-block btn-md btn-success" > -->               
            </div>
        </div>
        <p></p>
        <div class="row justify-content-md-center">
            <div class="col-md-6 justify-content-md-center">
                <div  class="jumbotron">
                    <textarea id="Fuente"></textarea>
                </div>
            </div>
            <div  class="col-md-6 justify-content-md-center">
                <div class="jumbotron">
                    <textarea id="Salida"></textarea>
                </div>
            </div>
        </div>
        <div class="row justify-content-md-center">
            <div class="col-md-6 justify-content-md-center">
                <!--<h5 align="center">Consola</h5> -->
                <input type="button" value="Consola" class="btn btn-block btn-md btn-dark" id="BtnConsola" >               
            </div>            
            <div class="col-md-6">
                <input type="button" value="Reporte de Errores" class="btn btn-block btn-md btn-danger" >                
            </div>
        </div>
        <p></p>
        <div class="row justify-content-md-center">
            <div  class="col-md-6 justify-content-md-center" >
                <div class="jumbotron" >
                    <textarea id="Consola"></textarea>
                </div>
            </div>
            <div  class="col-md-6 justify-content-md-center">
                <div class="jumbotron">
                    <!--<div class="col col-sm-12 col-md-10 col-lg-10 col-xl-10" style="width:820px; height:450px; overflow: scroll;" id="ReportErrors">-->

                    <div class="col col-sm-12 col-md-10 col-lg-10 col-xl-10" style="height:400px; overflow: scroll;" id="ReportErrors">
                    
                    </div>
                </div>
            </div>
        </div>
        <!--<div class="row justify-content-md-center">
            <div class="col-md-6">
                <h5 align="center">Consola</h5>
            </div>
            <div class="col-md-8">
                <div  class="jumbotron">
                    <textarea id="Consola"></textarea>
                </div>
            </div>
           
        </div>-->
        <p>  </p>
        <hr>
        <div class="row justify-content-md-center">
            <div class="col-md-6 justify-content-md-center">
                <input type="button" value="Tabla de Simbolos" class="btn btn-block btn-md btn-info" id="BtnTableSimbol">
            </div>
            <div class="col-md-6">
                <input type="button" value="Reporte Gramatical" class="btn btn-block btn-md btn-warning" >
            </div>
        </div>
        <p></p>
        <div class="row justify-content-md-center">
            <div class="col-md-6 justify-content-md-center">
                <div  class="jumbotron">
                    <!--<div class="col col-sm-12 col-md-10 col-lg-10 col-xl-10" style="width:820px; height:450px; overflow: scroll;" id="TableSimbol">-->                    
                    <div class="col col-sm-12 col-md-10 col-lg-10 col-xl-10" style="height:450px; overflow: scroll;" id="TableSimbol">
                    
                    </div>
                </div>
            </div>
            <div  class="col-md-6 justify-content-md-center">
                <div class="jumbotron">
                    <div class="col col-sm-12 col-md-10 col-lg-10 col-xl-10" id="ReportGramatical">
                    
                    </div>                    
                </div>
            </div>
        </div>        
        <div class="row justify-content-md-center">
            <div class="col-12">
              <div _ngcontent-pyl-c58="" id="graph-container" name="graph-container" style="text-align: center">
                    
              </div>
            </div>
            
        </div>     
        
    </div>    
    <!-- Gramatica-->
    <script type="text/javascript" src="./Gramatica/gramatica.js"></script>
    <!-- Arbol AST-->
    <script type="text/javascript" src="./AST/GramaticaAST.js"></script>
    <!--Interprete-->
    <script src="./Interprete/Abstract/Instruction.js"></script>
    <script src="./Interprete/Expresions/Primitive.js"></script>
    <script src="./Interprete/Expresions/Aritmetica.js"></script>
    <script src="./Interprete/Expresions/Strings.js"></script>
    <script src="./Interprete/Expresions/Relational.js"></script>
    <script src="./Interprete/Expresions/Logic.js"></script>
    <script src="./Interprete/Expresions/Identifier.js"></script>
    <script src="./Interprete/TS/Tree.js"></script>
    <script src="./Interprete/TS/TableSymbols.js"></script>
    <script src="./Interprete/TS/Type.js"></script>
    <script src="./Interprete/TS/Symbol.js"></script>
    <script src="./Interprete/TS/Exception.js"></script>
    <script src="./Interprete/Instructions/Print.js"></script>
    <script src="./Interprete/Instructions/Declaration.js"></script>
    <script src="./Interprete/Instructions/Assignation.js"></script>
    <script src="./Interprete/Instructions/While.js"></script>
    <script src="./Interprete/Instructions/Do.js"></script>
    <script src="./Interprete/Instructions/Break.js"></script>
    <script src="./Interprete/Instructions/Continue.js"></script>
    <script src="./Interprete/Instructions/Return.js"></script>
    <script src="./Interprete/Instructions/If.js"></script>
    <script src="./Interprete/Instructions/InstructionError.js"></script>
    <script src="./Interprete/Instructions/Switch.js"></script>
    <script src="./Interprete/Instructions/CaseSwitch.js"></script>
    <script src="./Interprete/Instructions/Function.js"></script>
    <script src="./Interprete/Instructions/CallFunction.js"></script>
    <script src="./Interprete/Instructions/For.js"></script>
    <script src="./Interprete/Instructions/ForIn.js"></script>
    <script src="./Interprete/Instructions/Natives.js"></script>
    <script src="./Interprete/Instructions/Post_fixed.js"></script>
    <script src="./Interprete/Instructions/Ternary.js"></script>
    <script src="./Interprete/Instructions/NativeMethods.js"></script>
    <script src="./Interprete/Instructions/TemplateStruct.js"></script>
    <script src="./Interprete/Instructions/CreateStruct.js"></script>
    <script src="./Interprete/Instructions/AccessAtributeStruct.js"></script>
    <script src="./Interprete/Instructions/ChangeValueStruct.js"></script>
    <script src="./Interprete/Instructions/DeclarationArray.js"></script>
    <script src="./Interprete/Instructions/ListObjects.js"></script>
    <script src="./Interprete/Instructions/AccessArray.js"></script>
    <script src="./Interprete/Instructions/ChangeValueArray.js"></script>
    <script src="./Interprete/Instructions/RangeArray.js"></script>
    <script src="./Interprete/Instructions/CopyArray.js"></script>
    <script src="./Interprete/Instructions/Dot.js"></script>

    <!-- Utils-->
    <script src="Utils/ErrorList.js"></script>
    <script src="Utils/ErrorType.js"></script>
    <script src="Utils/ErrorNode.js"></script>
    <script src="Utils/Node.js"></script>
    <SCRipt src="Utils/TableReport.js"></SCRipt>

    <!-- load the d3.js library --> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script src="./AST/chart/chart.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@1,500&display=swap" rel="stylesheet">

    <!--<script src="./AST/chart/chart.css"></script>-->
    <script src="./Utils/moveDivs.js"></script>
    <script>        
        var openFile = document.getElementById("open-file");
        openFile.addEventListener("change", (event) => {
        const fileUpload = event.target.files;
        //console.log(fileUpload);

        if (fileUpload.lenght == 0) {
            alert("Error: Seleccione un archivo");
            return;
        }

        var reader = new FileReader();
        reader.addEventListener("load", function (e) {
            var text = e.target.result;
            //var editor = getEditor();
            Fuente.setValue(text);
        });
        reader.readAsText(fileUpload[0]);
        });

        var Fuente = CodeMirror.fromTextArea(document.getElementById('Fuente'),{
            mode: "javascript",
            theme: "dracula",
            lineNumbers: true,
            autoCloseTags: true,
        });
        Fuente.setSize("770","400");
        var Salida = CodeMirror.fromTextArea(document.getElementById('Salida'),{
            mode: null,
            theme: "dracula",
            lineNumbers: true,
            autoCloseTags: true,
            readOnly: true
        });
        Salida.setSize("770","400");

        var Consola = CodeMirror.fromTextArea(document.getElementById('Consola'),{
            mode: null,
            theme: "isotope",
            lineNumbers: true,
            autoCloseTags: true,
            readOnly: true
        });
        Consola.setSize("770","400");

        function Compile(texto){
            Salida.setValue("");
            ErrorList.cleanErrorList();
            TableReport.cleanTableReport();
            texto = deleteKeys(texto);
            var instructions = gramatica.parse(texto);
            var tree = new Tree(instructions);
            var tsGlobal = new TableSymbols(null);
            tree.setGlobalTable(tsGlobal);
            tree.getInstructions().forEach(instruction=>{
                if(instruction instanceof Function){
                    tree.addFunction(instruction);
                }else if(instruction instanceof TemplateStruct){
                    tree.addStruct(instruction);
                }else{
                    if(instruction instanceof Declaration || instruction instanceof DeclarationArray || instruction instanceof CreateStruct){
                        var value = instruction.execute(tree, tsGlobal);
                        if (value instanceof Exception){
                            console.log(value);
                        }
                    }else{
                        ErrorList.addError(new ErrorNode(instruction.row, instruction.column,new ErrorType(EnumErrorType.SEMANTIC), "Instrucción fuera de función o metodo main", ENVIRONMENT.NULL));
                    }
                }
            });
            var exists = verifyMain(tree);
            if(exists){
                var newTable = new TableSymbols(tsGlobal);
                var result = tree.getFunction("main").execute(tree, newTable);
                if(result instanceof Exception) console.log(result);
            }else{
                console.log("Error, posibles causas: Hay más de un metodo main, no hay metodo main o el metodo main no es de tipo void ");
            }
            Salida.setValue(tree.getOut());
            showTableErrorsSymbols();
        }

        function verifyMain(tree){
            var count = 0, pass = true;
            var functions = tree.getFunctions();
            for(var i = 0; i<functions.length; i++){
                if(String(functions[i].name)==="main"){
                    if(functions[i].type !== Type.NULL){
                        pass = false;
                    }
                    count++;
                }
            }
            if (count !== 1) pass = false;
            return pass;
        }

        function deleteKeys(text){
            var out = "";
            var state = 0;
            for(var i = 0; i<text.length; i++){
                if(state === 0){
                    if(text[i]==='$'){
                        out += text[i];
                        state = 1;
                    }else{
                        out += text[i];
                    }
                }else if(state === 1){
                    if(text[i]==='('){
                        out += "\"&"
                        state = 3;
                    }else if(text[i]!=='('){
                        out+=text[i];
                        state = 0;
                    }
                }else if(state == 3){
                    if(text[i]===')'){
                        out += "&\""
                        state = 0;
                    }else{
                        out+=text[i];
                    }
                }
            }
            return out;
        }
        document.getElementById('BtnTableSimbol').onclick = function (){
            showTableExecuteSymbols();            
        }
        document.getElementById('BtnConsola').onclick = function (){
            showTableExecuteSymbols1();            
        }
        document.getElementById('BtnCompilar').onclick = function (){
            var Codigo = Fuente.getValue();
            Compile(Codigo);
            arbolast(Codigo);
        }
        document.getElementById('BtnLimpiar').onclick = function (){
            Fuente.setValue("");          
           
        }

        function arbolast(content){
            treeData = [];
            if (document.getElementById("grafo")) {
                document.getElementById("grafo").remove();
            }
            var result = GramaticaAST.parse(content);
            //document.getElementById("salida").value = result.val;
            generateTree([result.node]);
        }

        function newNode(yy, state, ...nodes) {
            const parent = getNonTerminal(yy, state);
            const children = [];
            //console.log(nodes);
            for (let node of nodes) {
                node.parent = node.parent ? node.parent : parent;
                if (node.parent == parent) {
                    children.push(node);
                } else if (typeof node == 'string') {
                    children.push({
                        name: node,
                        parent,
                        children: []
                    });
                } else {
                    children.push({
                        name: node.parent,
                        parent,
                        children: [node]
                    });
                }
            }

            return {
                name: parent,
                parent: null,
                children
            }
        }

        function getNonTerminal(yy, state) {
            const simbolos = yy.parser.symbols_;
            const produccion = yy.parser.productions_[state];
            let nonTerminal = '';
            for (let sim in simbolos) {
                if (simbolos[sim] === produccion[0]) {
                    nonTerminal = sim;
                    break;
                }
            }
            return nonTerminal;
        }

        const templist = [];

        function getTemp() {
            const temp = `t${templist.length}`;
            templist.push(temp);
            return temp;
        }
    

        function showTableErrorsSymbols() {            
            document.getElementById("ReportErrors").innerHTML = "";
        
            var html = "<h2>Reporte de Errores</h2>\n";
            html += '<table class="table table-light" id="ReportErrors">';
            html += '<thead class="thead-light">';
            html += "<tr>";
            html += '<th scope="col">#</th>';
            html += '<th scope="col">Linea</th>';
            html += '<th scope="col">Columna</th>';
            html += '<th scope="col">Tipo de Error</th>';
            html += '<th scope="col">Descripcion</th>';
            html += '<th scope="col">Entorno</th>';
            html += "</tr>";
            html += " </thead>";
            html += "<tbody>";
        
            var nodes = ErrorList.getErrorList();
            for (var i = 0; i < nodes.length; i++) {
            var item = nodes[i];
            html += "<tr>";
            html += `<td>${i + 1}</td>`;
            html += `<td>${item.line}</td>`;
            html += `<td>${item.column}</td>`;
            html += `<td>${item.errorType.toString()}</td>`;
            html += `<td>${item.description}</td>`;
            html += `<td>${item.environmentType.toString()}</td>`;
            html += "</tr>";
            }
        
            html += "</tbody>";
            html += "</table>";
            //console.log(html);
            document.getElementById("ReportErrors").innerHTML = html;
        }
        function showTableExecuteSymbols() {
            //var doc = new jspdf.jsPDF()
            
            //console.log(TableReport.SymbolList);
            document.getElementById("TableSimbol").innerHTML = "";
            var lineas = "[";
            var html = "<h2>Tabla de Simbolos Ejecucion</h2>\n";
            html += '<table class="table table-dark" id="TableSimbol">';
            html += '<thead class="thead-light">';
            html += "<tr>";
            html += '<th scope="col">#</th>';
            html += '<th scope="col">IDENTIFICADOR</th>';
            html += '<th scope="col">TIPO</th>';
            html += '<th scope="col">LINEA</th>';
            html += '<th scope="col">COLUMNA</th>';
            html += '<th scope="col">VALOR</th>';
            html += '<th scope="col">ENTORNO</th>';
            html += "</tr>";
            html += " </thead>";
            html += "<tbody>";
            var nodes = TableReport.getTableReport();
            for (var i = 0; i < nodes.length; i++) {
                var item = nodes[i];
                html += "<tr>";
                html += `<td>${i + 1}</td>`;
                html += `<td>${item.name}</td>`;
                html += `<td>${item.type==1?'INT':item.type==2?'DOUBLE':item.type==3?'STRING':item.type==4?'CHAR':item.type==5?'BOOLEAN':item.type==6?'STRUCT':item.type==7?'ARRAY':item.type=='VOID'?'VOID':'NULL'}</td>`;
                html += `<td>${item.line}</td>`;
                html += `<td>${item.column}</td>`;
                html += `<td>${item.value}</td>`;
                html += `<td>${item.typeEnviroment}</td>`;
                html += "</tr>";
                //lineas += ` ${i + 1}`,`${item.line}`,`${item.column}`,`${item.errorType.toString()}`,`${item.description}` ,`${item.environmentType.toString()}`;
                //lineas += "],";
                //console.log(lineas);
            }

            html += "</tbody>";
            html += "</table>";
            document.getElementById("TableSimbol").innerHTML = html;
            /*var body = [  
                [lineas],
                ];
                doc.autoTable({ head: head, body: body });

                // Simple html example
                doc.autoTable({ html: '#TableSimbol' });

                doc.save('TablaSimbolos.pdf');*/
        }
        function showTableExecuteSymbols1() {
            console.log("Entramos");
            var doc = new jspdf.jsPDF();
            SymbolList = [];
            var lineas = "{";    
            var nodes = TableReport.getTableReport();
            for (var i = 0; i < nodes.length; i++) {
                var item = nodes[i];   
                
                SymbolList.push([i + 1,item.name,item.type==1?'INT':item.type==2?'DOUBLE':item.type==3?'STRING':item.type==4?'CHAR':item.type==5?'BOOLEAN':item.type==6?'STRUCT':item.type==7?'ARRAY':item.type=='VOID'?'VOID':'NULL',item.line,item.column,item.value,item.typeEnviroment]);          
                //lineas += "[ "+i + 1+","+item.name+","+item.type+","+item.line+","+item.column+","+item.value+","+item.environmentType;
                //lineas += "],";
            }
            //lineas += "}";
            //console.log(lineas);
            //var doc = new jspdf.jsPDF()
            //console.log(SymbolList);
            // Simple data example
            
            var head = [['#', 'Identificador', 'Tipo','Linea', 'Columna','Valor','Entorno']]
            /*var body = [
            [1, 'Denmark', 7.526, 'Copenhagen'],
            [2, 'Switzerland', 7.509, 'Bern'],
            [3, 'Iceland', 7.501, 'Reykjavík'],
            ]
            //console.log(body);
            console.log(lineas);*/
            
            doc.autoTable({ head: head, body: SymbolList })

            // Simple html example
            doc.autoTable({ html: '#table' })

            doc.save('TablaSimbolos.pdf')
        }
    </script>
    

    <div id="root"></div>
  </body>
  <footer></footer>

</html>
